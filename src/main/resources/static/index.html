<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<video id="mainVideo"></video>
<video id="secondVideo"></video>
<script type="application/javascript">
    var Media = document.getElementById("mainVideo");
    var eventTester = function(e){
        Media.addEventListener(e,function(){
            console.log((new Date()).getTime(),e)
        },false);
    }
    eventTester("loadstart"); //客户端开始请求数据
    eventTester("progress"); //客户端正在请求数据
    eventTester("suspend"); //延迟下载
    eventTester("abort"); //客户端主动终止下载（不是因为错误引起）
    eventTester("loadstart"); //客户端开始请求数据
    eventTester("progress"); //客户端正在请求数据
    eventTester("suspend"); //延迟下载
    eventTester("abort"); //客户端主动终止下载（不是因为错误引起），
    eventTester("error"); //请求数据时遇到错误
    eventTester("stalled"); //网速失速
    eventTester("play"); //play()和autoplay开始播放时触发
    eventTester("pause"); //pause()触发
    eventTester("loadedmetadata"); //成功获取资源长度
    eventTester("loadeddata"); //
    eventTester("waiting"); //等待数据，并非错误
    eventTester("playing"); //开始回放
    eventTester("canplay"); //可以播放，但中途可能因为加载而暂停
    eventTester("canplaythrough"); //可以播放，歌曲全部加载完毕
    eventTester("seeking"); //寻找中
    eventTester("seeked"); //寻找完毕
    eventTester("timeupdate"); //播放时间改变
    eventTester("ended"); //播放结束
    eventTester("ratechange"); //播放速率改变
    eventTester("durationchange"); //资源长度改变
    eventTester("volumechange"); //音量改变

    //MSE的控制
    var mediaSource = new MediaSource();
    var video = document.querySelector('video');
    var video2 = document.getElementById('secondVideo');
    video.src = URL.createObjectURL(mediaSource);
    mediaSource.addEventListener('sourceopen', sourceOpen);
    function sourceOpen () {
        console.log((new Date()).getTime(),'sourceopen');
        // 这个奇怪的字符串后面再解释
        var mime = 'video/mp4; codecs="avc1.42E01E, mp4a.40.2"'

        // 新建一个 sourceBuffer
        var sourceBuffer = mediaSource.addSourceBuffer(mime);

        // 加载一段 chunk，然后 append 到 sourceBuffer 中
        fetchBuffer('https://localhost:8088/api/videos/SampleVideo.mp4', buffer => {
            sourceBuffer.appendBuffer(buffer)
    })
    }

    // 以二进制格式请求某个url
    function fetchBuffer (url, callback) {
        var xhr = new XMLHttpRequest;
        xhr.open('get', url);
        // xhr.responseType = 'video/mp4';
        xhr.onload = function () {
            console.log("xhr.onload");
            console.log(xhr.response);
            video2.src = URL.createObjectURL(xhr.response);
            callback(xhr.response);
        };
        xhr.send();
    }
</script>
</body>
</html>